package ru.trader.emdn;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.zeromq.ZMQ;

import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

public class EMDNEmul {
    private final static Logger LOG = LoggerFactory.getLogger(EMDNEmul.class);

    private ZMQ.Context context = null;
    private ZMQ.Socket publisher = null;
    private ScheduledExecutorService executor;
    private final String bindAddress;

    private final static byte[] message =  new byte[]{
            120, -100, -99, 90, -37, 78, -28, 70, 16, -3, 21, 11, -27, 49, 64, -33, -36, 23, -34, -128, 101, 119, -111, -128, -116, -128, 100, -91, 68, 121, 104, -58, -51, 76, 107, 109, -9, -60, 23, 96, -76, -38, 127, 79, 121, 88, -56, -70, -37, -104, -18, 60, 33, -58, 30, 31, 87, -43, -87, -86, 83, -43, -13, 109, 111, 109, 116, 97, -102, -67, -93, -20, -37, 94, -21, -18, -69, 71, -35, -104, 63, 76, -45, 90, 87, -61, 103, 123, -28, 0, 31, -16, 3, -76, -9, 107, -74, -73, -46, -99, 121, -44, -37, 91, 91, -103, -74, -45, -43, 102, 119, 25, 97, -66, -113, -44, 62, -106, -73, 24, 31, 81, 113, 68, -39, 1, 101, 10, -27, -4, -49, -31, 43, 47, 15, -68, -46, -107, 25, 110, 63, 59, -6, -112, 93, -22, -26, -85, -23, -78, 83, 87, -41, 102, -39, -71, 38, -5, -21, -117, -83, 11, -9, -40, -2, 61, 124, -93, -33, -108, 110, 120, -97, -13, 15, -61, -3, 87, -70, 91, -21, 58, -69, 54, -37, -38, -107, 69, -69, -9, 29, -18, -8, -91, 93, -82, 77, -91, -81, -51, -3, 112, -57, -70, -21, 54, 71, -121, -121, -49, -97, -75, 7, -90, -76, -99, -39, -81, 118, 16, -19, 65, 109, -70, 67, 83, 20, -11, -31, -46, 85, -107, 43, 108, -73, 61, 36, 3, 8, 24, -48, -22, -107, -39, -39, -4, 114, -55, -102, 22, -2, -1, -21, -37, 94, -3, -14, -82, 79, -16, 42, -83, 125, -128, -49, -31, 43, 119, -3, 118, -47, -40, -27, 112, 5, 13, -122, -11, -101, 77, -71, -3, -15, 79, 1, -48, 117, 1, -1, 80, -100, -53, -31, -94, 41, -53, -105, -101, 9, -59, -81, 119, 92, -104, 7, 83, 14, -113, -66, 112, -113, -125, 41, -1, 97, 125, -34, 22, -115, 91, -103, 58, -5, -40, -61, 29, 99, 56, -59, 94, -15, 94, 31, 112, 105, -118, -67, -97, -33, -126, -120, -100, 49, -14, -13, -85, 32, -17, 61, 20, -102, 6, 92, -104, -58, 61, -39, -62, 68, -37, 40, 56, 66, -116, 121, 79, -105, 59, -69, 61, 43, -121, -105, 28, -127, 94, -40, 127, 122, 91, 100, -65, 61, 109, 1, 57, -34, -87, 82, 50, -18, -69, -107, 74, 20, 1, -8, 5, 24, -37, 68, 3, 49, 33, -119, 7, -125, 9, -117, -120, -34, 105, -23, -70, -75, -83, 87, 30, 18, -63, -12, -3, -56, -55, -100, 34, 62, 23, 56, -84, -60, 24, -52, -43, 109, 95, -103, 38, -69, 53, -53, 53, 100, -123, 91, 109, -93, 45, -52, -103, -14, -98, -50, 115, 30, -61, -49, 15, 110, -56, 121, -69, -52, -114, -31, -79, 86, -41, -53, -124, -92, 80, 88, -27, 30, 106, -114, 39, -36, 26, 68, -17, -90, 111, 30, -20, -125, 46, -77, 51, -96, -51, -90, 50, 117, -25, 97, 114, -116, 67, 7, 127, -74, -85, -11, -56, -61, 12, 1, -127, -26, 60, -100, 11, 53, -62, 61, 46, 87, 58, 62, 31, 48, -25, 36, -96, 13, -51, 35, -100, 122, 92, -37, 10, -84, -69, 52, -38, 55, 108, 6, 13, 49, 28, 112, 84, -14, 24, -110, -70, -5, 123, 19, 111, 22, 69, 126, -54, 69, -30, 124, -76, -19, 58, 26, -123, 40, -18, -105, 18, -122, 104, 12, -118, 115, 69, 118, -86, -101, -82, -79, -59, 42, 32, 35, -55, 35, 120, 1, 97, -49, 21, -99, 35, 6, 30, -13, -30, 99, -45, -37, 46, 59, -82, -117, -20, 15, -77, 50, -99, -66, 43, 19, -78, 0, 99, -30, 7, 14, -70, 69, -124, -91, -97, 26, 109, -29, -117, 37, 23, 44, -24, 64, 72, 68, -64, -36, 108, -21, 110, 109, -122, 20, 79, -30, -93, 32, -62, -121, -53, 73, 4, -36, -83, -47, -15, 5, -124, 115, 63, 48, 44, 87, 49, -108, -65, -68, 4, -103, 81, 109, -96, -117, 119, -15, -52, 103, -120, 96, -65, 96, -47, 92, 77, 112, 63, -88, 88, -89, -90, -47, 21, -72, -16, 21, 52, -98, 31, -48, 86, 41, -11, 115, -127, -14, -119, 92, -40, 17, 121, 4, 123, 14, 29, -95, -44, 29, 116, 32, 8, 94, 117, -41, -24, 58, -95, 124, 73, -91, -4, 16, 74, 26, 101, -19, -62, -107, 91, 104, 68, 9, 57, 32, 49, -24, 69, 63, -106, 81, 124, -71, 49, -32, 87, 87, 23, -3, -96, 24, 19, 122, -113, -32, 74, 76, 52, -11, 24, -13, 110, -6, -115, 105, -2, 7, 38, -25, 52, 104, 120, 92, -55, 9, -62, 6, -112, -57, 93, -27, -38, -51, -38, -64, -73, -78, 69, -29, -96, -53, -74, 33, 50, 97, -30, 125, 89, -127, 17, 84, 107, -4, -21, 76, 113, 35, 100, 92, -35, 78, 122, 91, 22, 3, -123, 62, -22, 59, -72, 69, 79, -40, 44, -40, -124, -96, 9, -22, 42, 84, 58, -124, -26, -112, 5, -106, -29, -84, 105, -36, 38, -5, -84, 27, 80, -38, 93, 72, 39, -48, 63, -14, 125, 123, 41, -49, 5, -55, -25, 80, -79, -62, -7, 8, -10, 12, -72, 11, 58, 116, -71, -51, 22, -18, 17, -12, -44, 41, -36, -100, 32, -11, 21, 87, 33, -79, -56, -124, -104, 10, -13, -11, -20, 105, -83, -5, -74, -125, 73, -88, -74, -9, 48, -41, 68, -125, 74, 22, -42, 66, -2, -109, -77, -33, 102, -42, 39, 51, 40, 69, 8, -21, -37, 106, 10, 83, -94, 34, -62, 75, 37, -27, 114, -66, 109, 2, -11, -58, -61, -58, 85, 118, -77, 118, -53, -81, -39, -91, -21, 3, 88, 74, 98, -24, 76, 56, -57, 106, 14, -108, -30, -15, -128, 3, 83, -90, -83, -51, -101, -58, 82, 46, 38, 52, 66, 48, 86, 17, -108, -85, -39, -79, -118, 114, -60, -58, -72, -128, -38, 12, 94, 126, -22, 26, -99, 86, 56, -64, 111, 57, 14, -60, -87, -118, -23, 116, -49, 12, -2, 100, 6, -20, 9, 76, 74, 98, 82, 8, 13, -8, -13, 62, 38, -29, 10, -7, -43, 86, -61, 36, -78, 107, 119, 53, 56, -39, -57, 125, 118, -34, -69, 5, 67, 16, 60, 59, 2, 65, 106, -113, -59, 3, 84, -56, 65, 57, -97, 58, 87, 14, 21, -21, -9, -38, 6, -48, -104, 78, -104, 28, -110, 89, -112, -7, -39, 0, 19, 17, 78, -108, -39, -94, 111, -20, -67, 13, 107, -43, -77, -44, 122, -113, 84, -110, -55, -9, 42, -43, -72, 43, 20, 15, -61, -60, 85, 64, 115, 47, -20, 18, -8, -107, 80, -91, -104, -56, -3, -126, 1, -13, -26, -60, -12, 21, 86, -87, 19, -35, -18, -44, -32, 52, 38, -106, 49, -108, -54, -7, 59, 10, 91, -116, -77, 103, 97, -102, 123, 7, -79, 5, 115, -77, -77, 122, 61, -4, 77, 72, 32, -103, -109, 96, -66, 85, 40, -90, -15, 46, 118, -53, 16, 59, 108, -93, -46, -38, 0, 22, 65, 61, -114, -101, -88, -113, -53, -66, -78, -75, -19, -85, 120, -21, 96, 88, 82, -66, -72, 103, 52, 102, -15, 114, 98, -102, 109, 89, -90, -128, 49, -56, -97, 64, 22, 74, 20, 37, -126, -35, -99, 46, -29, 39, -120, 64, 29, -96, 24, -9, -99, -70, -51, 38, 97, -75, -125, 41, -62, -66, 57, 76, -60, 8, -49, 79, 58, -51, 113, 32, -39, 69, -64, -62, 92, 76, -51, 43, 97, -109, 78, -47, 2, 56, 23, -49, -37, -87, -47, -106, 79, -119, -104, -51, -54, 121, 93, 36, -39, -124, -111, 84, 62, 20, 103, 108, 98, 56, -103, -40, -7, 117, -21, 36, -106, 43, -54, -126, 42, 33, 81, -116, 85, -65, -75, 85, 10, 18, 52, 29, -102, -5, 18, 78, 9, 26, 53, 114, 45, -128, 22, 58, -55, -119, 88, -28, -31, 36, 2, 50, 36, 70, -67, 45, 118, -45, 93, 2, -104, -30, -71, 63, 103, 17, -118, 80, 76, -83, 88, 52, -70, 53, -82, -40, 38, -7, 18, 99, 70, -112, -49, 122, -127, -24, 4, -21, 67, 95, -34, -24, 10, -60, 90, 10, 26, -31, 68, 80, -97, -113, 32, -42, -94, -48, 108, -7, -112, 80, 57, 8, 35, 44, -104, -53, 115, 74, 38, 106, 71, -32, -54, 91, 93, 119, -70, 76, -87, -70, 57, -55, 81, 80, -89, -30, -74, -91, -73, -74, -45, 73, -3, -124, 112, -124, -125, 26, -113, 17, -113, -87, -118, -65, 55, 105, 88, -100, 34, 73, -4, -120, 81, -52, 99, -56, 127, -94, -5, -89, 112, 127, -109, 71, -20, -42, 41, 97, -13, 67, 3, 99, 126, -101, 4, -47, 14, -75, 49, 64, 3, 114, 71, -116, 11, 24, 114, -100, -50, 42, 89, -104, 39, -104, -41, -57, 74, 8, -101, -81, -83, 48, -118, 64, 3, 14, 18, 57, 7, 6, -79, -108, 97, 47, 11, 108, -125, 70, 18, 33, -27, -80, 82, -104, -51, -61, -27, -98, 86, 62, -97, -14, 36, -106, 56, 70, 35, -109, -9, 78, 69, -96, -93, -114, -5, -116, -39, -40, -62, 77, -104, -57, 112, -60, -7, 25, -120, 54, -114, -26, -16, -88, -94, 99, 56, -9, -104, -35, -102, 106, 51, -52, 91, 125, 99, -78, 15, 86, 87, -82, 46, -30, -123, 35, -108, 16, 31, -125, 75, 37, -93, -10, 7, 11, 13, -54, 49, 97, -93, -119, 17, -14, 23, 82, 2, 50, 35, -86, -47, 93, -9, -99, 45, -61, 116, -104, -104, -21, -62, 108, 32, -49, -117, -80, -73, -125, 40, 69, 88, 85, 38, 44, -29, 18, -67, 15, -57, 114, 37, -59, 28, 26, -60, -40, -53, -10, -124, 54, -64, 105, 32, -128, -80, -120, 89, -33, -97, 56, -41, -107, 102, -107, 13, 103, -97, 46, -95, -19, -48, 96, 19, -64, -13, 9, -11, 29, 6, 44, 17, 40, 92, 56, -112, 9, -107, 16, -18, -17, 65, -28, 47, -105, 46, -66, -77, 5, 71, -85, 76, -96, 24, -1, 125, -79, 9, -53, 108, 42, -108, 63, -114, -59, 29, 71, -100, 15, -103, 108, 117, -103, -35, -108, 58, -27, -64, 63, -84, -127, -126, -60, 28, 95, 29, -9, -99, -37, 127, 123, -47, 58, -89, 16, -124, -33, -78, -87, 100, 49, -121, -44, 39, -42, 53, -90, -24, -105, -61, -62, -28, -62, 46, -41, 41, 39, -16, -96, 74, 60, 80, 73, -30, -50, 28, -85, 77, -33, -51, 109, -120, 104, 30, -111, -38, 84, -87, -7, -115, 9, -91, -29, 5, -47, -25, -125, -77, -125, -20, -90, 15, -73, 66, 51, -114, 37, 66, -95, -32, 44, 50, 110, 83, 114, 105, -105, -115, 27, 126, -48, -46, 53, -82, 44, 83, 54, 22, 34, 56, 14, 1, 81, 20, 115, 92, 119, -19, -18, 92, 103, -105, 9, -10, 41, 22, 44, 15, 8, -58, 49, 35, -36, -23, -13, 25, -120, 125, 48, 63, -50, 6, 18, -42, 35, 76, -15, 112, -100, 35, 81, -57, 75, 23, 70, 119, -21, -108, 25, 31, -28, 44, -90, -2, 16, 66, -89, 78, 63, 3, -84, -85, -95, -117, 67, -6, 39, -37, -121, -123, -16, 17, -29, 14, -80, -1, 59, 111, 77, -58, 28, -104, -22, -125, -30, -88, -77, 121, -88, 1, -113, -70, 13, 53, 89, 76, 55, -89, 10, -49, 110, 74, -57, 114, -20, 102, -39, -24, -115, -81, 26, 34, -124, -97, -62, 114, 94, 101, -110, -79, 14, -69, 114, -11, -2, -123, -23, -42, 16, -69, 47, 70, 67, -115, 73, -31, 102, 48, -4, 8, 30, -29, -59, 107, -93, -97, -77, -31, -72, -87, 92, 31, 79, 80, -118, -88, -33, 4, 9, 126, -109, 44, 127, -61, -25, -35, -4, 79, -19, -24, -13, 111, -20, -74, 16, -47, -22, -22, 85, 111, 20, 107, -35, 104, -69, -5, 21, 25, 124, -73, -77, -82, 126, -71, 118, 92, -34, -11, -107, 110, 117, -109, 93, 15, -65, 86, -6, -2, -3, 95, 16, -95, -39, -65
    };

    public EMDNEmul(String bindAddress) {
        this.bindAddress = bindAddress;
    }

    public void start(){
        if (publisher != null) shutdown();
        context = ZMQ.context(1);
        publisher = context.socket(ZMQ.PUB);

        LOG.debug("Start EMDN emul server, address {}", bindAddress);
        publisher.bind(bindAddress);

        executor = Executors.newSingleThreadScheduledExecutor();
        executor.scheduleAtFixedRate(() -> {
            LOG.trace("Publish message: {}", message);
            publisher.send(message);
            LOG.trace("Sleep... ");
        }, 1, 5, TimeUnit.SECONDS);
    }

    public void shutdown(){
        if (publisher!=null){
            LOG.debug("Shutdown EMDN emul server");
            executor.shutdown();
            publisher.close();
            context.term();
        }
        publisher = null;
        context = null;
    }

}
